name: Secret and Sensitive Data Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  gitleaks-scan:
    name: Scan for Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_COMMENTS: false

  trufflehog-scan:
    name: Scan for Secrets (TruffleHog)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified --fail

  sensitive-data-scan:
    name: Scan for PII and Sensitive Data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for email addresses
        run: |
          echo "Scanning for email addresses..."
          # Exclude common false positives (example emails, package files, git directory)
          EMAILS=$(grep -rEI --include="*.{js,ts,py,rb,go,java,php,yml,yaml,json,env,config,cfg,ini,txt,md}" \
            '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' . \
            --exclude-dir='.git' \
            --exclude-dir='node_modules' \
            --exclude-dir='vendor' \
            --exclude-dir='.github' \
            --exclude='package*.json' \
            --exclude='*.lock' \
            2>/dev/null || true)

          # Filter out common false positives
          FILTERED=$(echo "$EMAILS" | grep -viE '(example\.com|test\.com|localhost|noreply|@users\.noreply\.github\.com|user@|foo@|bar@|someone@|placeholder)' || true)

          if [ -n "$FILTERED" ]; then
            echo "::warning::Potential email addresses found:"
            echo "$FILTERED"
            echo "EMAIL_FOUND=true" >> $GITHUB_ENV
          else
            echo "No suspicious email addresses found."
          fi

      - name: Scan for phone numbers
        run: |
          echo "Scanning for phone numbers..."
          # Look for various phone number formats
          PHONES=$(grep -rEI --include="*.{js,ts,py,rb,go,java,php,yml,yaml,json,env,config,cfg,ini,txt,md}" \
            '(\+?1?[-.\s]?)?\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4}' . \
            --exclude-dir='.git' \
            --exclude-dir='node_modules' \
            --exclude-dir='vendor' \
            --exclude-dir='.github' \
            2>/dev/null || true)

          # Filter out common false positives (timestamps, IDs, etc.)
          FILTERED=$(echo "$PHONES" | grep -viE '(version|id|port|timestamp|example|test|000-000-0000|123-456-7890|555-)' || true)

          if [ -n "$FILTERED" ]; then
            echo "::warning::Potential phone numbers found:"
            echo "$FILTERED"
            echo "PHONE_FOUND=true" >> $GITHUB_ENV
          else
            echo "No suspicious phone numbers found."
          fi

      - name: Scan for IP addresses (non-localhost)
        run: |
          echo "Scanning for hardcoded IP addresses..."
          IPS=$(grep -rEI --include="*.{js,ts,py,rb,go,java,php,yml,yaml,json,env,config,cfg,ini}" \
            '\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b' . \
            --exclude-dir='.git' \
            --exclude-dir='node_modules' \
            --exclude-dir='vendor' \
            --exclude-dir='.github' \
            -P 2>/dev/null || true)

          # Filter out localhost and common safe IPs
          FILTERED=$(echo "$IPS" | grep -viE '(127\.0\.0\.[0-9]+|0\.0\.0\.0|localhost|192\.168\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\.|255\.255\.|example|test)' || true)

          if [ -n "$FILTERED" ]; then
            echo "::warning::Potential hardcoded IP addresses found:"
            echo "$FILTERED"
            echo "IP_FOUND=true" >> $GITHUB_ENV
          else
            echo "No suspicious IP addresses found."
          fi

      - name: Check for PII findings
        run: |
          if [ "$EMAIL_FOUND" = "true" ] || [ "$PHONE_FOUND" = "true" ] || [ "$IP_FOUND" = "true" ]; then
            echo "::error::Potential PII or sensitive data detected. Please review the warnings above."
            exit 1
          fi
          echo "No PII detected."

  cached-artifacts-scan:
    name: Scan for Cached Files and Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for files that should not be committed
        run: |
          echo "Scanning for cached files and artifacts..."
          FOUND_ISSUES=false

          # Define patterns for files that shouldn't be committed
          PATTERNS=(
            # Cache directories
            "__pycache__"
            ".cache"
            ".pytest_cache"
            ".mypy_cache"
            ".ruff_cache"
            "*.pyc"
            "*.pyo"

            # Node/JS artifacts
            "node_modules"
            ".npm"
            ".yarn/cache"
            "*.tsbuildinfo"

            # Build artifacts
            "dist/"
            "build/"
            "*.egg-info"
            "*.egg"
            "*.whl"

            # IDE/Editor files
            ".idea"
            ".vscode/settings.json"
            "*.swp"
            "*.swo"
            "*~"
            ".DS_Store"
            "Thumbs.db"

            # Log files
            "*.log"
            "npm-debug.log*"
            "yarn-debug.log*"
            "yarn-error.log*"

            # Coverage/test artifacts
            "coverage/"
            ".coverage"
            "htmlcov/"
            ".nyc_output"

            # Compiled files
            "*.so"
            "*.dll"
            "*.dylib"
            "*.exe"
            "*.o"
            "*.obj"
          )

          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(find . -name "$pattern" -not -path "./.git/*" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              echo "::warning::Found cached/artifact files matching '$pattern':"
              echo "$MATCHES"
              FOUND_ISSUES=true
            fi
          done

          if [ "$FOUND_ISSUES" = true ]; then
            echo "::error::Cached files or build artifacts found in repository. Please add them to .gitignore."
            exit 1
          fi

          echo "No cached files or artifacts found."

  sensitive-config-scan:
    name: Scan for Sensitive Config Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for sensitive environment and config files
        run: |
          echo "Scanning for sensitive configuration files..."
          FOUND_ISSUES=false

          # Files that should never be committed (containing secrets)
          SENSITIVE_FILES=(
            ".env"
            ".env.local"
            ".env.development.local"
            ".env.test.local"
            ".env.production.local"
            ".env.production"
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"
            "*.jks"
            "id_rsa"
            "id_dsa"
            "id_ecdsa"
            "id_ed25519"
            ".netrc"
            ".npmrc"
            ".pypirc"
            "credentials.json"
            "service-account*.json"
            "*-credentials.json"
            "secrets.yml"
            "secrets.yaml"
            "secrets.json"
            ".htpasswd"
            "wp-config.php"
            "config/database.yml"
            "database.yml"
            "settings.py"
            "local_settings.py"
            "config.php"
            ".aws/credentials"
            ".docker/config.json"
          )

          for pattern in "${SENSITIVE_FILES[@]}"; do
            MATCHES=$(find . -name "$pattern" -not -path "./.git/*" -type f 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              echo "::error::Sensitive configuration file found: $pattern"
              echo "$MATCHES"
              FOUND_ISSUES=true
            fi
          done

          if [ "$FOUND_ISSUES" = true ]; then
            echo "::error::Sensitive configuration files detected. These should not be committed to the repository."
            exit 1
          fi

          echo "No sensitive configuration files found."

      - name: Scan config files for secrets patterns
        run: |
          echo "Scanning configuration files for secret patterns..."

          # Patterns that indicate secrets in config files
          SECRET_PATTERNS=(
            'password\s*[:=]'
            'passwd\s*[:=]'
            'secret\s*[:=]'
            'api_key\s*[:=]'
            'apikey\s*[:=]'
            'api-key\s*[:=]'
            'access_token\s*[:=]'
            'auth_token\s*[:=]'
            'private_key\s*[:=]'
            'client_secret\s*[:=]'
            'aws_secret'
            'aws_access_key'
            'AKIA[0-9A-Z]{16}'
          )

          FOUND_ISSUES=false

          for pattern in "${SECRET_PATTERNS[@]}"; do
            MATCHES=$(grep -riE "$pattern" . \
              --include="*.yml" \
              --include="*.yaml" \
              --include="*.json" \
              --include="*.xml" \
              --include="*.ini" \
              --include="*.cfg" \
              --include="*.conf" \
              --include="*.config" \
              --include="*.properties" \
              --include="*.toml" \
              --exclude-dir='.git' \
              --exclude-dir='node_modules' \
              --exclude-dir='vendor' \
              --exclude-dir='.github' \
              2>/dev/null || true)

            # Filter out template/example values and environment variable references
            FILTERED=$(echo "$MATCHES" | grep -viE '(\$\{|\$\(|<%=|{{|%>|example|placeholder|your[-_]|changeme|xxx|TODO|FIXME|<.*>|\[\[|\]\])' || true)

            if [ -n "$FILTERED" ]; then
              echo "::warning::Potential secrets found matching pattern '$pattern':"
              echo "$FILTERED"
              FOUND_ISSUES=true
            fi
          done

          if [ "$FOUND_ISSUES" = true ]; then
            echo "::error::Potential secrets detected in configuration files. Please review and use environment variables or secret management."
            exit 1
          fi

          echo "No secrets patterns found in configuration files."

  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [gitleaks-scan, trufflehog-scan, sensitive-data-scan, cached-artifacts-scan, sensitive-config-scan]
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "=== Security Scan Summary ==="

          if [ "${{ needs.gitleaks-scan.result }}" != "success" ]; then
            echo "::error::Gitleaks scan failed - secrets may be present"
            FAILED=true
          else
            echo "✓ Gitleaks scan passed"
          fi

          if [ "${{ needs.trufflehog-scan.result }}" != "success" ]; then
            echo "::error::TruffleHog scan failed - verified secrets may be present"
            FAILED=true
          else
            echo "✓ TruffleHog scan passed"
          fi

          if [ "${{ needs.sensitive-data-scan.result }}" != "success" ]; then
            echo "::error::PII/Sensitive data scan failed"
            FAILED=true
          else
            echo "✓ PII/Sensitive data scan passed"
          fi

          if [ "${{ needs.cached-artifacts-scan.result }}" != "success" ]; then
            echo "::error::Cached files/artifacts scan failed"
            FAILED=true
          else
            echo "✓ Cached files/artifacts scan passed"
          fi

          if [ "${{ needs.sensitive-config-scan.result }}" != "success" ]; then
            echo "::error::Sensitive config scan failed"
            FAILED=true
          else
            echo "✓ Sensitive config scan passed"
          fi

          if [ "$FAILED" = true ]; then
            echo ""
            echo "::error::One or more security scans failed. Please review the job outputs above."
            exit 1
          fi

          echo ""
          echo "All security scans passed successfully!"
